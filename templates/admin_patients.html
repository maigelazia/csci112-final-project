{% extends "admin_base.html" %}

{% block title %}Patients{% endblock %}

{% block content %}
<h2>Patients</h2>

<div class="filters">
    <input type="text" id="search" placeholder="Search patient name, email, ID">

    <!-- quite confused where to get medical condition and allergy data for now -->
    <!-- <input type="text" id="condition" placeholder="Filter by condition">
    <input type="text" id="allergy" placeholder="Filter by allergy"> -->

    <select id="sort">
        <option value="full_name">Sort by Name</option>
        <option value="patient_id">Sort by ID</option>
    </select>

    <select id="order">
        <option value="asc">ASC</option>
        <option value="desc">DESC</option>
    </select>

    <button onclick="loadPatients()">Apply</button>
    <button onclick="clearFilters()">Clear</button>
</div>

<table class="table">
    <thead>
        <tr>
            <th>Patient ID</th>
            <th>Name</th>
            <th>Email & Contact</th>
            <th>Location</th>
            <th>Medical</th>
        </tr>
    </thead>
    <tbody id="patients-body"></tbody>
</table>

{% endblock %}

{% block scripts %}
<script>

async function loadPatients() {
    const params = new URLSearchParams({
        search: document.getElementById("search").value,
        // condition: document.getElementById("condition").value,
        // allergy: document.getElementById("allergy").value,
        sort: document.getElementById("sort").value,
        order: document.getElementById("order").value,
        page: 1,
        page_size: 50
    });

    const resp = await fetch(`/api/admin/patients?${params.toString()}`);
    const data = await resp.json();

    console.log("Loaded patients:", data.results); // for debugging

    const rows = data.results.map(p => `
        <tr>
            <td>${p.patient_id}</td>
            <td>${p.full_name}</td>
            <td>
                ${p.email}<br>
                <small>${p.contact_number}</small>
            </td>
            <td>${p.address_city}, ${p.address_state}</td>
            <td>
                Conditions: ${
                    Array.isArray(p.medical_history?.conditions)
                    ? p.medical_history.conditions.length
                    : 0
                }<br>
                Allergies: ${
                    Array.isArray(p.medical_history?.allergies)
                    ? p.medical_history.allergies.length
                    : 0
                }
            </td>
        </tr>
    `);

    document.getElementById("patients-body").innerHTML = rows.join("");
}

function clearFilters() {
    document.getElementById("search").value = "";
    // document.getElementById("condition").value = "";
    // document.getElementById("allergy").value = "";
    
    document.getElementById("sort").value = "full_name";
    document.getElementById("order").value = "asc";

    loadPatients();
}

loadPatients();
</script>
{% endblock %}