{% extends "admin_base.html" %}
{% block title %}Admin | Patients{% endblock %}

{% block content %}

<h2>Patient Records</h2>

<div class="filters">

    <input type="text" id="search" placeholder="Search patients...">
    <input type="text" id="condition" placeholder="Filter by condition">
    <input type="text" id="allergy" placeholder="Filter by allergy">

    <select id="sort">
        <option value="full_name">Sort by Name</option>
        <option value="patient_id">Sort by ID</option>
        <option value="created_at">Sort by Created</option>
    </select>

    <select id="order">
        <option value="asc">ASC</option>
        <option value="desc">DESC</option>
    </select>

    <button onclick="fetchPatients()">Apply</button>
    <button onclick="clearFilters()" class="clear-btn">Clear</button>
</div>

<div class="table-wrapper">
<table class="table" id="patients-table">
    <thead>
        <tr>
            <th>Patient ID</th>
            <th>Basic Info</th>
            <th>Medical History</th>
            <th>Appointment History</th>
        </tr>
    </thead>
    <tbody id="patients-body"></tbody>
</table>
</div>

{% endblock %}

{% block scripts %}
<script>

function fetchPatients() {
    const params = new URLSearchParams({
        search: document.getElementById("search").value,
        condition: document.getElementById("condition").value,
        allergy: document.getElementById("allergy").value,
        sort: document.getElementById("sort").value,
        order: document.getElementById("order").value
    });

    fetch(`/api/admin/patients?${params.toString()}`)
        .then(res => res.json())
        .then(data => loadPatients(data.results));
}

function clearFilters() {
    document.getElementById("search").value = "";
    document.getElementById("condition").value = "";
    document.getElementById("allergy").value = "";
    document.getElementById("sort").value = "full_name";
    document.getElementById("order").value = "asc";
    fetchPatients();
}

function loadPatients(list) {
    const tbody = document.getElementById("patients-body");
    tbody.innerHTML = "";

    list.forEach(p => {

        // Determine if medical sections should show
        const validConditions = Array.isArray(p.conditions) && p.conditions.some(c => c && c.condition);
        const validAllergies  = Array.isArray(p.allergies)  && p.allergies.some(a => a && a.substance);

        const medId = `med-${p.patient_id}`;
        const histId = `hist-${p.patient_id}`;

        const row = `
        <tr>
            <td>${p.patient_id}</td>

            <td>
                <strong>${p.full_name}</strong><br>
                ${p.email}<br>
                ${p.contact_number}
            </td>

            <!-- MEDICAL HISTORY COLUMN -->
            <td>
                ${
                    (validConditions || validAllergies)
                    ? `
                        <button class="details-btn" onclick="toggleDetails('${medId}')">
                            View Medical History
                        </button>

                        <div class="details-container" id="${medId}">
                            ${
                                validConditions
                                ? `
                                    <strong>Conditions:</strong>
                                    <ul>
                                        ${
                                            p.conditions
                                                .filter(c => c && c.condition)
                                                .map(c => `
                                                    <li>
                                                        <b>${c.condition}</b>
                                                        ${c.medications ? ` — ${c.medications}` : ""}
                                                        ${
                                                            typeof c.controlled === "boolean"
                                                            ? ` (${c.controlled ? "controlled" : "uncontrolled"})`
                                                            : ""
                                                        }
                                                    </li>
                                                `).join("")
                                        }
                                    </ul>
                                `
                                : ""
                            }

                            ${
                                validAllergies
                                ? `
                                    <strong>Allergies:</strong>
                                    <ul>
                                        ${
                                            p.allergies
                                                .filter(a => a && a.substance)
                                                .map(a => `
                                                    <li>
                                                        <b>${a.substance}</b>
                                                        ${a.reaction ? ` — ${a.reaction}` : ""}
                                                    </li>
                                                `).join("")
                                        }
                                    </ul>
                                `
                                : ""
                            }
                        </div>
                    `
                    : "<i>No medical data</i>"
                }
            </td>

            <!-- APPOINTMENT HISTORY COLUMN -->
            <td>
                ${
                    Array.isArray(p.appointment_history) && p.appointment_history.length > 0
                    ? `
                        <button class="details-btn" onclick="toggleDetails('${histId}')">
                            View History
                        </button>

                        <div class="details-container" id="${histId}">
                            <ul>
                                ${
                                    p.appointment_history.map(h => `
                                        <li>
                                            <b>${h.date}</b> @ ${h.time} — ${h.concern}<br>
                                            <b>Status:</b> ${h.status}<br>
                                            <b>Branch:</b> ${h.branch || "N/A"}
                                        </li>
                                    `).join("")
                                }
                            </ul>
                        </div>
                    `
                    : "<i>No appointments recorded</i>"
                }
            </td>
        </tr>
        `;

        tbody.innerHTML += row;
    });
}

function toggleDetails(id) {
    const e = document.getElementById(id);
    e.style.display = e.style.display === "block" ? "none" : "block";
}

fetchPatients();
</script>
{% endblock %}
