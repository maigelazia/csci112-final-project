{% extends "admin_base.html" %}

{% block title %}Appointments{% endblock %}

{% block content %}
<h2>Appointments</h2>

<div class="filters">
    <input type="text" id="search" placeholder="Search name, email, concern...">
    
    <select id="status">
        <option value="">All Status</option>
        <option value="Pending">Pending</option>
        <option value="Arrived">Arrived</option>
        <option value="Completed">Completed</option>
        <option value="Cancelled">Cancelled</option>
    </select>

    <select id="branch">
        <option value="">All Branches</option>
        <option value="Main">Makati Main Clinic</option>
        <option value="West">Pasig-Ortigas Dental Hub</option>
        <option value="South">Manila Downtown Clinic</option>
        <option value="South">BGC Dental Center</option>
        <option value="South">Quezon City Branch</option>
    </select>

    <select id="sort">
        <option value="appointment_details.preferred_date">Sort by Date</option>
        <option value="patient.full_name">Sort by Name</option>
        <option value="appointment_id">Sort by ID</option>
    </select>

    <select id="order">
        <option value="asc">ASC</option>
        <option value="desc">DESC</option>
    </select>

    <button onclick="loadAppointments()">Apply</button>
    <button onclick="clearFilters()" class="clear-btn">Clear</button>
</div>

<table class="table">
    <thead>
        <tr>
            <th>Appointment ID</th>
            <th>Patient</th>
            <th>Date</th>
            <th>Time</th>
            <th>Concern</th>
            <th>Branch</th>
            <th>Status</th>
        </tr>
    </thead>
    <tbody id="appointments-body"></tbody>
</table>

<div id="statusModal" class="modal" style="display:none;">
    <div class="modal-content">
        <h3>Edit Appointment Status</h3>

        <p><strong>Appointment ID:</strong> <span id="modal-appointment-id"></span></p>

        <select id="new-status">
            <option value="Pending">Pending</option>
            <option value="Arrived">Arrived</option>
            <option value="Completed">Completed</option>
            <option value="Cancelled">Cancelled</option>
        </select>

        <div class="modal-actions">
            <button onclick="updateStatus()">Save</button>
            <button onclick="closeStatusModal()">Cancel</button>
        </div>
    </div>
</div>
{% endblock %}


{% block scripts %}
<script>
async function loadAppointments() {
    const params = new URLSearchParams({
        search: document.getElementById("search").value,
        status: document.getElementById("status").value,
        branch: document.getElementById("branch").value,
        sort: document.getElementById("sort").value,
        order: document.getElementById("order").value,
        page: 1,
        page_size: 50
    });

    const resp = await fetch(`/api/admin/appointments?${params.toString()}`);
    const data = await resp.json();

    const rows = data.results.map(a => `
        <tr>
            <td>${a.appointment_id}</td>
            <td>
                ${a.patient.full_name}<br>
                <small>${a.patient.email}</small><br>
                <small>${a.patient.contact_number}</small>
            </td>
            <td>${a.appointment_details.preferred_date}</td>
            <td>${a.appointment_details.preferred_time}</td>
            <td>${a.appointment_details.concern || "â€”"}</td>
            <td>${a.appointment_details.clinic_branch}</td>
            <td><strong>${a.appointment_details.status}</strong></td>

            <td>
                <button class="edit-btn" onclick="openStatusModal('${a.appointment_id}', '${a.appointment_details.status}')">
                    Edit
                </button>
            </td>
        </tr>
    `);

    document.getElementById("appointments-body").innerHTML = rows.join("");
}

function clearFilters() {
    document.getElementById("search").value = "";
    document.getElementById("status").value = "";
    document.getElementById("branch").value = "";
    document.getElementById("sort").value = "appointment_details.preferred_date";
    document.getElementById("order").value = "asc";

    loadAppointments(); // refresh list with default filters
}

loadAppointments();

let selectedAppointmentId = null;

function openStatusModal(appointmentId, currentStatus) {
    selectedAppointmentId = appointmentId;
    document.getElementById("modal-appointment-id").innerText = appointmentId;
    document.getElementById("new-status").value = currentStatus;

    document.getElementById("statusModal").style.display = "block";
}

function closeStatusModal() {
    document.getElementById("statusModal").style.display = "none";
    selectedAppointmentId = null;
}

async function updateStatus() {
    const newStatus = document.getElementById("new-status").value;

    const resp = await fetch(`/api/admin/appointments/${selectedAppointmentId}/status`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ status: newStatus })
    });

    if (resp.ok) {
        closeStatusModal();
        loadAppointments(); // refresh table
    } else {
        alert("Failed to update status");
    }
}
</script>
{% endblock %}